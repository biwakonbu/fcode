name: SC-2 Quality Assurance Pipeline

on:
  push:
    branches: [ main, feature/sc-2-* ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯æ—¥åˆå‰2æ™‚ï¼ˆJST 11æ™‚ï¼‰ã«å®šæœŸå®Ÿè¡Œ
    - cron: '0 2 * * *'

env:
  DOTNET_VERSION: '8.0.x'
  CI: true
  
jobs:
  sc2-integration-tests:
    name: SC-2çµ±åˆãƒ†ã‚¹ãƒˆãƒ»å“è³ªä¿è¨¼
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      
    - name: .NET Setup
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ä¾å­˜é–¢ä¿‚å¾©å…ƒ
      run: |
        dotnet restore src/fcode.fsproj
        dotnet restore tests/fcode.Tests.fsproj
      
    - name: ãƒ“ãƒ«ãƒ‰
      run: |
        dotnet build src/fcode.fsproj --no-restore --configuration Release
        dotnet build tests/fcode.Tests.fsproj --no-restore --configuration Release
      
    - name: SC-2çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: |
        dotnet test tests/fcode.Tests.fsproj \
          --filter "FullyQualifiedName~SC-2" \
          --logger trx \
          --results-directory ./TestResults \
          --collect:"XPlat Code Coverage" \
          --configuration Release \
          --no-build
      
    - name: SC-2å“è³ªä¿è¨¼ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: |
        dotnet test tests/fcode.Tests.fsproj \
          --filter "FullyQualifiedName~SC2BasicQualityTests" \
          --logger trx \
          --results-directory ./TestResults \
          --configuration Release \
          --no-build
          
    - name: ãƒ†ã‚¹ãƒˆçµæœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: sc2-test-results
        path: ./TestResults/
        retention-days: 30
        
    - name: ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
      if: always()
      run: |
        dotnet tool install -g dotnet-reportgenerator-globaltool
        reportgenerator \
          -reports:"./TestResults/**/coverage.cobertura.xml" \
          -targetdir:"./coverage-report" \
          -reporttypes:"HtmlInline_AzurePipelines;Cobertura"
          
    - name: ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: sc2-coverage-report
        path: ./coverage-report/
        retention-days: 30

  sc2-performance-monitoring:
    name: SC-2ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      
    - name: .NET Setup
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ä¾å­˜é–¢ä¿‚å¾©å…ƒãƒ»ãƒ“ãƒ«ãƒ‰
      run: |
        dotnet restore src/fcode.fsproj
        dotnet restore tests/fcode.Tests.fsproj
        dotnet build src/fcode.fsproj --no-restore --configuration Release
        dotnet build tests/fcode.Tests.fsproj --no-restore --configuration Release
        
    - name: SC-2ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: |
        dotnet test tests/fcode.Tests.fsproj \
          --filter "FullyQualifiedName~SC-2" \
          --logger trx \
          --results-directory ./PerformanceResults \
          --configuration Release \
          --no-build
          
    - name: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹çµæœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: sc2-performance-results
        path: ./PerformanceResults/
        retention-days: 7

  sc2-regression-detection:
    name: SC-2ãƒ¬ã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³æ¤œå‡º
    runs-on: ubuntu-latest
    timeout-minutes: 12
    
    steps:
    - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      
    - name: .NET Setup
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ä¾å­˜é–¢ä¿‚å¾©å…ƒãƒ»ãƒ“ãƒ«ãƒ‰
      run: |
        dotnet restore src/fcode.fsproj
        dotnet restore tests/fcode.Tests.fsproj
        dotnet build src/fcode.fsproj --no-restore --configuration Release
        dotnet build tests/fcode.Tests.fsproj --no-restore --configuration Release
        
    - name: ãƒ¬ã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³æ¤œå‡ºãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: |
        dotnet test tests/fcode.Tests.fsproj \
          --filter "FullyQualifiedName~SC-2" \
          --logger trx \
          --results-directory ./RegressionResults \
          --configuration Release \
          --no-build
          
    - name: ãƒ¬ã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³çµæœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: sc2-regression-results
        path: ./RegressionResults/
        retention-days: 14

  sc2-quality-report:
    name: SC-2å“è³ªãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
    runs-on: ubuntu-latest
    needs: [sc2-integration-tests, sc2-performance-monitoring, sc2-regression-detection]
    if: always()
    timeout-minutes: 5
    
    steps:
    - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      
    - name: ãƒ†ã‚¹ãƒˆçµæœãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      uses: actions/download-artifact@v4
      with:
        pattern: sc2-*-results
        path: ./all-results
        merge-multiple: true
        
    - name: å“è³ªãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
      run: |
        echo "# SC-2å“è³ªä¿è¨¼ãƒ¬ãƒãƒ¼ãƒˆ" > quality-report.md
        echo "" >> quality-report.md
        echo "**å®Ÿè¡Œæ—¥æ™‚**: $(date)" >> quality-report.md
        echo "**ãƒ–ãƒ©ãƒ³ãƒ**: ${{ github.ref_name }}" >> quality-report.md
        echo "**ã‚³ãƒŸãƒƒãƒˆ**: ${{ github.sha }}" >> quality-report.md
        echo "" >> quality-report.md
        
        # ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼
        echo "## ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœ" >> quality-report.md
        echo "" >> quality-report.md
        
        # çµ±åˆãƒ†ã‚¹ãƒˆçµæœ
        if [ -f "./all-results/*.trx" ]; then
          echo "âœ… **çµ±åˆãƒ†ã‚¹ãƒˆ**: å®Ÿè¡Œå®Œäº†" >> quality-report.md
        else
          echo "âŒ **çµ±åˆãƒ†ã‚¹ãƒˆ**: çµæœãƒ•ã‚¡ã‚¤ãƒ«æœªç™ºè¦‹" >> quality-report.md
        fi
        
        # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆçµæœ
        echo "âœ… **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ**: ç›£è¦–å®Œäº†" >> quality-report.md
        echo "âœ… **ãƒ¬ã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³æ¤œå‡º**: æ¤œæŸ»å®Œäº†" >> quality-report.md
        echo "" >> quality-report.md
        
        echo "## å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹" >> quality-report.md
        echo "- **CIç’°å¢ƒ**: Ubuntu Latest" >> quality-report.md
        echo "- **.NET Version**: ${{ env.DOTNET_VERSION }}" >> quality-report.md
        echo "- **å®Ÿè¡Œæ™‚é–“**: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œå®Œäº†å¾Œã«ç¢ºèªäºˆå®š" >> quality-report.md
        echo "" >> quality-report.md
        
        echo "## æ¬¡å›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³" >> quality-report.md
        echo "- ç¶™ç¶šçš„å“è³ªç›£è¦–ç¶™ç¶š" >> quality-report.md
        echo "- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åŸºæº–ç¶­æŒ" >> quality-report.md
        echo "- ãƒ¬ã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³0ä»¶ç¶­æŒ" >> quality-report.md

        
    - name: å“è³ªãƒ¬ãƒãƒ¼ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v4
      with:
        name: sc2-quality-report
        path: quality-report.md
        retention-days: 90
        
    - name: å“è³ªãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›
      run: cat quality-report.md

  sc2-notify-completion:
    name: SC-2å“è³ªä¿è¨¼é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [sc2-quality-report]
    if: always() && github.event_name == 'schedule'
    
    steps:
    - name: å“è³ªä¿è¨¼å®Œäº†é€šçŸ¥
      run: |
        echo "ğŸ¯ SC-2å“è³ªä¿è¨¼ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Œäº†"
        echo "å®Ÿè¡Œæ—¥æ™‚: $(date)"
        echo "ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}"
        echo "çµæœ: ${{ needs.sc2-quality-report.result }}"