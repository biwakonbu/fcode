# FC-002: IPC Unix Domain Socket (UDS) フレーミング + 同時接続シリアライズ

## 背景
`docs/pty-architecture.md` セクション 15.1 では、複数 UI クライアントが同一 Unix ドメインソケットに接続する際の競合と、メッセージフレーミング方式 (length-prefix) の実装リスクが指摘されています。本検証では、実運用に耐える UDS 通信レイヤを設計・検証します。

## 目的
1. `length-prefix (4-byte big-endian + JSON)` 方式の送受信ラッパを実装し、パフォーマンスと安定性を検証する。
2. `System.Threading.Channels` を用いた単一コンシューマ + 複数プロデューサ構成で、同時接続競合を回避できるかを確認する。
3. エラー時 (不正長, タイムアウト, 切断) のハンドリングを網羅したリファレンス実装を得る。

## 作業内容
- [ ] `FSharp.UDS` (仮) ライブラリを作成し、以下 API を提供する。
  - `async SendAsync<'T>` : Envelope<'T> を送信
  - `async ReceiveAsync<'T>` : Envelope<'T> を受信 (ストリームからフレーミング解除)
- [ ] サーバ側: `Channel<SessionCommand>` にプッシュし、単一 consumer タスクが順序どおり処理する実装を追加。
- [ ] クライアント側: 10 本の並列タスクで大量リクエストを送信し、順序性とスループットを計測するベンチマークを実装。
- [ ] 異常系テスト: 不正 JSON, size mismatch, 途中切断, タイムアウト。
- [ ] 検証結果を `docs/ipc-uds-results.md` にまとめる。

## 受け入れ基準
- [ ] 1 万 req/s の負荷でメッセージロス 0, 順序保証が保たれること。
- [ ] 99 パーセンタイルレイテンシ < 2 ms (ローカル同一ホスト)。
- [ ] 異常時にハングやクラッシュせず、明確な例外を返すこと。

## 参照
- `docs/pty-architecture.md` セクション 15.1

---
**担当**: @
**見積**: 1.5 人日
**優先度**: 🟥 高 
