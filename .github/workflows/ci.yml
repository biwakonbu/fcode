name: CI

on:
  pull_request:
    branches: [ main, develop ]

jobs:
  format-lint-test-build:
    runs-on: ubuntu-latest
    env:
      DOTNET_CLI_TELEMETRY_OPTOUT: "1"
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    # NuGet ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.fsproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
    
    # 1. ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
    - name: Check F# formatting
      run: |
        dotnet tool install -g fantomas
        fantomas --check src/ tests/
    
    # 2. ãƒªãƒ³ãƒˆ (F# Analyzer + è­¦å‘Šãƒã‚§ãƒƒã‚¯ - FSharpLintã¯CIç’°å¢ƒã§ä¸å®‰å®šãªãŸã‚ä»£æ›¿æ‰‹æ®µä½¿ç”¨)
    - name: Restore dependencies for linting
      run: |
        dotnet restore src/fcode.fsproj
        dotnet restore tests/fcode.Tests.fsproj
    
    - name: Run F# linting
      run: |
        echo "ğŸ”§ Building with detailed warnings for SOLID refactoring..."
        dotnet build src/fcode.fsproj --configuration Debug --verbosity normal -p:TreatWarningsAsErrors=true -p:WarningsNotAsErrors=FS0760
        echo "âœ… Build completed with acceptable warnings"
    
    # 3. ãƒ†ã‚¹ãƒˆå“è³ªãƒã‚§ãƒƒã‚¯
    - name: Verify test categorization
      run: |
        echo "ğŸ“Š Verifying test categorization by examining source files..."
        
        # Count TestFixture and Test methods to ensure proper categorization
        TESTFIXTURE_COUNT=$(find tests -name "*.fs" -exec grep -c "\[<TestFixture>\]" {} \; | awk '{sum += $1} END {print sum}')
        CATEGORY_COUNT=$(find tests -name "*.fs" -exec grep -c "\[<Category" {} \; | awk '{sum += $1} END {print sum}')
        TEST_COUNT=$(find tests -name "*.fs" -exec grep -c "\[<Test>" {} \; | awk '{sum += $1} END {print sum}')
        
        echo "  TestFixture count: $TESTFIXTURE_COUNT"
        echo "  Category attributes found: $CATEGORY_COUNT"
        echo "  Test methods found: $TEST_COUNT"
        
        # Ensure we have sufficient categorization (TestFixture categories cover multiple tests)
        if [ "$CATEGORY_COUNT" -ge "$TESTFIXTURE_COUNT" ]; then
          echo "âœ… Test categorization verified: $TESTFIXTURE_COUNT TestFixtures with $CATEGORY_COUNT categories for $TEST_COUNT tests"
        else
          echo "âŒ Insufficient categories: Need at least one category per TestFixture ($TESTFIXTURE_COUNT TestFixtures, $CATEGORY_COUNT categories)"
          exit 1
        fi
    
    # 4. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ (30ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒ»UIä¾å­˜ãƒ†ã‚¹ãƒˆé™¤å¤–)
    - name: Run CI-safe unit tests
      run: dotnet test tests/fcode.Tests.fsproj --configuration Debug --verbosity quiet --logger trx --results-directory TestResults --filter "TestCategory=Unit&TestCategory!=UI" --blame-hang-timeout 30000ms --blame-crash --nologo 2>/dev/null
      env:
        TERM: dumb
        CI: true
        TERMINFO: /dev/null
        NO_COLOR: 1
        
    # 5. CIå®‰å…¨ãƒ†ã‚¹ãƒˆæ•°æ¤œè¨¼
    - name: Verify CI-safe test count
      run: |
        CI_SAFE=$(dotnet test tests/fcode.Tests.fsproj --filter "TestCategory=Unit&TestCategory!=UI" --list-tests | wc -l)
        echo "âœ… CIå®‰å…¨ãƒ†ã‚¹ãƒˆæ•°: $CI_SAFE"
        if [ $CI_SAFE -lt 150 ]; then
          echo "âš ï¸  CIå®‰å…¨ãƒ†ã‚¹ãƒˆãŒå°‘ãªã„ã§ã™ï¼ˆæœŸå¾…å€¤: 150ä»¥ä¸Šï¼‰"
        fi
    
    # - name: Upload test results
    #   uses: actions/upload-artifact@v4
    #   if: always()
    #   with:
    #     name: test-results
    #     path: TestResults/
    
    # 4. ãƒªãƒªãƒ¼ã‚¹ãƒ“ãƒ«ãƒ‰
    - name: Build release
      run: |
        dotnet build src/fcode.fsproj --configuration Release --verbosity normal
    
    # Linuxå‘ã‘å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ¥
    - name: Publish Linux x64
      run: dotnet publish src/fcode.fsproj -c Release -r linux-x64 --self-contained true -p:PublishSingleFile=true -o publish/linux-x64

    - name: Upload Linux artifact
      uses: actions/upload-artifact@v4
      with:
        name: fcode-linux-x64
        path: publish/linux-x64/fcode

# build-macos:
#   runs-on: macos-latest
#   needs: format-lint-test-build
#   env:
#     DOTNET_CLI_TELEMETRY_OPTOUT: "1"
#
#   steps:
#   - uses: actions/checkout@v4
#
#   - name: Setup .NET
#     uses: actions/setup-dotnet@v4
#     with:
#       dotnet-version: '8.0.x'
#
#   # NuGet ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚­ãƒ£ãƒƒã‚·ãƒ¥
#   - name: Cache NuGet packages
#     uses: actions/cache@v4
#     with:
#       path: ~/.nuget/packages
#       key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.fsproj') }}
#       restore-keys: |
#         ${{ runner.os }}-nuget-
#
#   - name: Restore dependencies
#     run: |
#       dotnet restore src/fcode.fsproj --verbosity normal
#       dotnet restore tests/fcode.Tests.fsproj --verbosity normal
#
#   - name: Run CI-safe unit tests on macOS
#     run: dotnet test tests/fcode.Tests.fsproj --configuration Debug --verbosity minimal --filter "TestCategory=Unit&TestCategory!=UI" --blame-hang-timeout 90000ms
#     env:
#       TERM: xterm
#       CI: true
#
#   # macOSå‘ã‘å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ¥
#   - name: Publish macOS x64
#     run: dotnet publish src/fcode.fsproj -c Release -r osx-x64 --self-contained true -p:PublishSingleFile=true -o publish/osx-x64
#
#   - name: Upload macOS artifact
#     uses: actions/upload-artifact@v4
#     with:
#       name: fcode-macos-x64
#       path: publish/osx-x64/fcode