# Product Requirements Document (PRD)

## 1. 目的 (Objective)
Claude Code を最大限活用するための専用 **TUI ラッパー** を提供し、オンライン環境下で高速・快適に AI コーディング支援を受けられる環境を実現する。
+複数の Claude Code インスタンスをペインごとに同時起動し、生成結果を直列に受け渡す "AI パイプライン" を構築することで、コード品質と開発速度の双方を向上させることを目指す。

## 2. 背景 (Background)
- GUI IDE に比べてリソース消費が少なく、リモート開発 (SSH/WSL) でも軽快に動作するツールが求められている。
- Claude Code を統合し、チャット・コード補完・リファクタリング提案をワークフローに組み込みたい。
- 既存の TUI エディタ + AI プラグインではセットアップが煩雑。ワンバイナリ、または簡易インストールで完結する体験を目指す。
- Claude API を直接呼び出すのではなく、公式開発ツール **Claude Code CLI** を内部でラップして提供する。

## 3. チーム構成 & 役割 (Team Composition & Roles)
| ロール | 人数 | 主要責務 |
|--------|-----|-----------|
| Product Manager (PM) | 1 | プロジェクト全体の進行管理、ステークホルダー(依頼者)との調整 |
| Product Designer/Manager (PdM) | 1 | 要件定義、優先順位付け、ユーザーストーリー策定 |
| シニアエンジニア | 1 | 技術的リード、アーキテクチャ設計、コードレビュー最終承認 |
| エンジニア | 2 | 機能実装、リファクタリング、ユニットテスト作成 |
| QA エンジニア | 2 | テスト計画策定・実行、ヒューリスティックテスト、品質ゲート管理 |
| UI/UX デザイナー | 1 | 画面設計、ユーザビリティレビュー |
| ステークホルダー (あなた) | 1 | 要件提示・最終意思決定 |

### QA 方針
- QA チームがテストケースを主導で作成し、エンジニアへ指示を配布する。
- **ヒューリスティックテスト** を積極的に採用し、未知の不具合やユーザビリティ課題を早期発見する。
- Claude Code との連携により、テスト観点リストやバグ再現プロンプトを自動生成し、タイムラインに共有。

#### テスト実行方法 (Test Execution Procedure)
本プロジェクトでは **ユニットテスト** と **TUI E2E テスト** を同一の `dotnet test` コマンドで実行できるよう構成する。開発者・QA・CI すべてで同一手順を採用し、テスト結果の再現性を担保する。

| 種類 | 目的 | 実行コマンド | 主なドライバ / ツール | 備考 |
|------|------|--------------|-----------------------|------|
| ユニットテスト | 純粋関数・ユーティリティの検証 | `dotnet test` | NUnit | カテゴリ無し (既定) |
| TUI E2E テスト | 画面レイアウト／キーバインドの回帰検証 | `dotnet test --filter "Category=E2E"` | Terminal.Gui **FakeDriver** | 端末を初期化せずに TUI を仮想実行し、画面バッファを直接アサートする |
| 手動 TUI デバッグ | 人間が実際に UI を触って確認 | `tmux new-session -d -s fcode 'dotnet run --project src/fcode'`<br/>`tmux send-keys -t fcode <keys>`<br/>`tmux capture-pane -pt fcode -J` | **tmux** | 端末破壊を防ぎつつキー送信・画面取得が可能 |

追加ガイドライン
- CI では `dotnet test --collect:"XPlat Code Coverage"` を実行し、カバレッジ閾値 80% 未満で失敗させる。
- すべてのプルリクエストはテストが緑になることを **Definition of Done** とする。
- `FakeDriver` ベース E2E は高速 (数十 ms) で完了し、ターミナル設定を汚さないためローカル開発ループに組み込むことを推奨。
- 端末実機の不具合再現には `tmux` スクリプトを併用し、`capture-pane` 出力をバグ報告の添付資料として残す。

## 4. 主要ユースケース (Use Cases)
1. プロジェクトディレクトリを開き、エディタペインでコード編集しつつ、隣のペインで Claude に質問/生成指示を送る。
2. CLI からテストを実行し、その結果を Claude に渡してデバッグ方針を提案してもらう。
<!-- Git 連携ユースケースは不要のため削除 -->

## 5. コア機能 (Key Features)
-  <!-- (旧仕様) 水平 / 垂直分割、ペインのリサイズ・移動 -->
  - 水平 / 垂直分割、ペインのリサイズ・移動
  - プロセス毎にタブ／セッションを管理
- マルチペイン管理
  - 自動レイアウト (プリセット構成: 横並び・上下分割・グリッドなどをワンショットで生成)
  - 必要最小限のペイン移動・リサイズ操作のみ提供し、ユーザ設定の負荷を軽減
  - 各ペインに複数の Claude Code インスタンスを割り当て、同時並行で利用可能
  - ペイン間でプロンプト／レスポンスを連鎖させるパイプライン機能 (Claude Code A → B → C など)
- 外部エディタ呼び出しサポート
+<!-- (非採用) 外部エディタ呼び出しサポート -->
@@
-   - キーバインド体系
+<!--   キーバインド体系 (非採用) -->
@@
-     - デフォルトは Emacs 風 (Ctrl/Meta ショートカット) を提供
+<!--     デフォルトは Emacs 風 (Ctrl/Meta ショートカット) を提供 (非採用) -->
@@
-     - すべてのコマンド/ショートカットはユーザ定義ファイルで自由に再マップ可能
+<!--     すべてのコマンド/ショートカットはユーザ定義ファイルで自由に再マップ可能 (非採用) -->
+<!-- (非採用)     - すべてのコマンド/ショートカットはユーザ定義ファイルで自由に再マップ可能 -->
- Claude チャット統合
  - ストリーム表示、コードブロックレンダリング
  - プロンプトプリセット ("リファクタリング提案", "テスト生成" など)
- ファイルブラウザ & プロジェクトツリー (オプション)
- ターミナルエミュレーション
- <!-- Git 連携は不要のため削除 -->
- キーバインドカスタマイズ (Emacs/Vim 風)
+ サブエージェント可視化 & コラボレーション
  - 左端固定の「会話ペイン」を提供し、以下のグループ種別ごとにスレッドを一覧表示 (横断的グループ/統括、チーム別、個人分報)。ペインを開いたまま他ペインでの操作を阻害しないフローティングレイアウトを採用し、メッセージはリアルタイムにストリーム更新される。
  - すべての Claude Code インスタンス（サブエージェント含む）のプロンプト / レスポンスをタイムラインで一覧表示
  - 会話ログを Markdown / JSON 形式でエクスポートし、チームレビューや QA 資料として共有可能
  - 各メッセージにメタ情報 (モデル名・トークン数・生成時間) を付与しトレーサビリティを確保
  - ログファイルをリモートストレージ (Git リポジトリや社内 KB) に自動保存するオプション
  - 共有モード (読み取り専用) と編集モード (追記・コメント) を切替可能
  - ロール／メンバータグ機能 (pm, dev1, qa1 など) でフィルタ・ハイライトが可能
  - 自動サマリー & ハイライト Bot が各タグの会話を定期集約し、進捗・TODO・懸念点を生成
  - メッセージ単位で `needs-review` `approved` などレビューフラグを付与し、担当者へ通知
  - 外部ツール連携: GitHub Issue/Pull Request, Slack/Teams, Jira などへサマリーやリンクを自動ポスト
  - 権限モード: Broadcast (全ペインへ同報) / Request (タグ指定で質問→回答リダイレクト) をサポート
  - PM ダッシュボード: タスク/スケジュールを一元管理し、エージェント毎の期限遵守状況を自動トラッキング。遅延時はリマインド通知を送信し、調整依頼フローを起動する。

## 6. 非目標 (Non-Goals)
- フル機能 GUI IDE の代替 (デバッガのブレークポイント可視化など高度 GUI 要素)
- オフラインでの完全動作 (Claude API 通信は必須。ただし一部キャッシュは検討)

## 7. 技術的前提・制約 (Technical Considerations)

### 7.1 基本技術仕様
- 実装言語: **F# (.NET 8)** + Terminal.Gui
- 対応プラットフォーム: Linux, macOS を第一級サポート (Windows は対象外)
- 配布形態: まずは .NET 8 のシングルファイル publish による **F# 製単一バイナリ** を優先 (将来的に Homebrew/Scoop/PyPI 対応も検討)
- Claude API Key 管理: API キーは不要（Claude Code CLI 側で認証を処理）
- 必須依存: ローカルに Claude Code CLI (バージョン要件 TBD) がインストール済みであること
- 設定管理: 設定ファイルは `~/.config/claude-tui/config.toml` を予定。保存する項目（CLI パスやプロファイル名など）は未確定 (TBD)

### 7.2 プロセス分離アーキテクチャ設計
**Claude Code統合における堅牢性要件を満たすため、tmuxライクなプロセス分離アーキテクチャを採用**

#### 7.2.1 アーキテクチャ概要
```
┌─────────────────────────────────┐
│ fcode メインプロセス             │
│ (TUI管理・ユーザーインターフェース) │
├─────────────────────────────────┤
│ プロセススーパーバイザー           │
│ - セッション管理                  │
│ - 健全性監視                     │
│ - 自動復旧                      │
└─┬───────────────────────────────┘
  │ IPC (Named Pipes / Unix Sockets)
  ├── Claude Code Worker 1 (dev1)
  ├── Claude Code Worker 2 (dev2)
  ├── Claude Code Worker 3 (dev3)
  ├── Claude Code Worker 4 (qa1)
  ├── Claude Code Worker 5 (qa2)
  ├── Claude Code Worker 6 (ux)
  └── Claude Code Worker 7 (pm)
```

#### 7.2.2 設計原則
1. **完全なプロセス分離**: メインTUIプロセスとClaude Codeインスタンスの独立性確保
2. **クラッシュ分離**: 個別ワーカープロセスの異常終了がシステム全体に波及しない
3. **セッション永続性**: tmuxライクなデタッチ/アタッチ機能により、ネットワーク断絶時も作業継続可能
4. **自動復旧**: プロセス監視と自動再起動による高い可用性

#### 7.2.3 技術的制約とリスク軽減策

**Claude Code特有のリスク要因**:
- **JavaScriptランタイム依存**: Node.jsベースによるメモリリーク・GC問題
- **ネットワーク依存性**: Claude API通信での接続エラー・タイムアウト
- **長時間実行の不安定性**: セッション状態の劣化・応答性低下
- **リソース消費**: 複数インスタンス同時実行での負荷増大

**リスク軽減策**:
1. **プロセス監視システム**
   - ハートビート監視 (2秒間隔): プロセス生存確認
   - メモリ監視: 使用量しきい値超過時の警告・自動再起動
   - 応答性監視: API応答時間の継続的測定
   - CPU使用率監視: 異常な負荷検出時の介入

2. **予防的メンテナンス**
   - 定期リブート: 30-60分間隔での計画的再起動
   - セッション状態リセット: 一定時間経過後の強制初期化
   - メモリ使用量制限: プロセス毎のリソース上限設定
   - ガベージコレクション誘発: 定期的なメモリ最適化

3. **データ保護・復旧機能**
   - 自動セッション保存: 作業状態の定期的バックアップ
   - グレースフルシャットダウン: 正常終了処理による状態保存
   - 即座の復旧: 異常終了検出から3秒以内の自動再起動
   - コンテキスト復元: セッション履歴と実行コンテキストの自動復元

4. **ユーザーエクスペリエンス保護**
   - 非侵入的通知: 復旧処理の透明性確保
   - 手動介入オプション: 自動復旧失敗時のマニュアル操作
   - 状況可視化: プロセス状態の分かりやすい表示
   - フォールバック機能: 全システム障害時の安全な終了処理

#### 7.2.4 実装優先順位
1. **Phase 1**: プロセススーパーバイザー基盤実装
2. **Phase 2**: 健全性監視・自動復旧システム
3. **Phase 3**: tmuxライクセッション永続化機能
4. **Phase 4**: 予防的メンテナンス・最適化機能

この設計により、Claude Codeの不安定性に起因するユーザー体験の悪化を防ぎ、安定した開発環境を提供する。

## 8. ヒアリング項目 (Hearing Items)
以下の質問に順次ご回答いただくことで、要件を確定させます。

1. 想定ユーザ・利用シナリオ
   - **回答: 個人開発者向けで確定**
   - **回答: オンライン限定**（Claude Code CLI がクラウドと通信する前提）
2. 必須機能
   - マルチペインのデフォルトレイアウトやキーバインドの理想形は？
   - **回答: モダンな自動レイアウトを提供し、ユーザによるカスタマイズは最小限 (初期状態で快適に利用可能)**
   - プロジェクトブラウザや Git 連携の優先度は？
   <!-- Git 連携に関する優先度質問は削除 -->
3. 技術スタックの希望
   - **回答: 実装言語は F# を採用**
   - 依存ライブラリ候補: Spectre.Console, Terminal.Gui など .NET 向け TUI フレームワーク
4. 対応プラットフォーム
   - Linux（WSL2）、macOS、Windows（PowerShell/CMD）すべてサポートするか？
   - **回答: Windows はサポート対象外 (Linux / macOS のみ)**
   - 配布方法（pip, brew, Scoop, 単一バイナリ等）の希望は？
   - **回答: まずは .NET シングルファイル publish による F# 単一バイナリで配布し、後日パッケージマネージャ対応を検討**
5. セキュリティ・認証
   - Claude API Key は不要（Claude Code CLI 内部で管理）。
   - CLI 用トークンやログイン情報のキャッシュ方式は？
   - **回答: 認証・キャッシュは Claude Code CLI に委任。本ツール側では実装しない**
6. ライセンス / OSS 方針
   - **回答: MIT ライセンスを採用**
   - 外部コントリビューションを受け入れるポリシーは？

## 9. 既知のリスク (Risks)
- TUI フレームワークの安定性: Textual はまだ β 版で大規模利用実績が少ない。

## 10. 未解決事項 / オープンクエスチョン (Open Questions)
以下はヒアリングが必要な項目。確定後、PRD を更新する。

3. Git 連携の実装範囲？
+<!-- Git 連携に関するオープンクエスチョンは削除 -->
4. 依存ライブラリ・実装言語の最終選定？
5. 配布方法と CI/CD の詳細？
6. ライセンス・コントリビューションポリシー確定？

---

> 本ドキュメントは初稿です。ヒアリング結果を反映し次第、順次アップデートします。 
