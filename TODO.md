# fcode開発 TODO - 詳細進捗管理

**最終更新**: 2025-06-25  
**総実装ライン数**: 758行 (src/), 472行 (tests/)  
**テストカバレッジ**: 29テストケース / 100%パス  

---

## 📊 現在の実装状況サマリー

### ✅ 完全実装済み (100%)
- **UI基盤**: 8ペインレイアウト、カラースキーム統一
- **キーバインド**: Emacsスタイル完全対応 (246行)
- **ログシステム**: 包括的デバッグログ出力 (71行)
- **テストスイート**: 29テストケース、100%パス

### 🔄 部分実装済み (70%)
- **Claude Code統合**: 基盤実装済み、自動起動に課題
- **プロセス管理**: SessionManager実装済み (190行)

### ❌ 未実装 (0%)
- **I/O統合**: Claude Code出力のTUI表示
- **ペイン間連携**: コンテキスト共有機能

---

## 1. 完了済み基盤機能 ✅

### 1.1 開発環境・ビルド基盤
- [x] **.NET 8 SDK環境構築** (.NET 8.0.101)
- [x] **Terminal.Gui 1.5.0統合** (fsproj設定完了)
- [x] **F#プロジェクト構成** (src/, tests/分離)
- [x] **単一ファイルパブリッシュ対応** (linux-x64)

### 1.2 UI基盤実装 (完全実装)
- [x] **8ペインレイアウト構成** (会話60列+dev1-3+qa1-2+ux+PM)
- [x] **レスポンシブレイアウト** (上段40%/中段40%/下段20%)
- [x] **フラット表示会話ペイン** (ボーダーレス設計)
- [x] **二重枠問題解消** (FrameView → View変更)
- [x] **統一カラースキーム** (ターミナルデフォルト色)
- [x] **TextView自動配置** (全エージェントペインに配置)

### 1.3 キーバインドシステム (完全実装)
- [x] **Emacsスタイルマルチキー** (Ctrl+X プレフィックス対応)
- [x] **アプリケーション制御** (Ctrl+X Ctrl+C: 終了)
- [x] **ペイン移動操作** (Ctrl+X O: 次ペイン, Ctrl+X Ctrl+O: 前ペイン)
- [x] **ダイレクト移動** (Ctrl+X 0-7: 指定ペイン移動)
- [x] **Claude Code制御** (Ctrl+X S: 起動, Ctrl+X K: 終了)
- [x] **システム操作** (Ctrl+L: リフレッシュ, Ctrl+X H: ヘルプ)
- [x] **キーシーケンスタイムアウト** (2秒自動リセット)
- [x] **インタラクティブヘルプ** (操作方法表示ダイアログ)

### 1.4 ログ・デバッグシステム (完全実装)
- [x] **包括的ログシステム** (/tmp/fcode-logs/出力)
- [x] **4段階ログレベル** (DEBUG/INFO/WARN/ERROR)
- [x] **カテゴリ別ログ** (Application/UI/AutoStart/SessionManager)
- [x] **スレッドセーフ実装** (lock機構)
- [x] **例外詳細記録** (スタックトレース含む)
- [x] **タイムスタンプ精度** (ミリ秒単位)

### 1.5 テスト基盤 (完全実装)
- [x] **NUnitテストフレームワーク** (29テストケース)
- [x] **キーバインドテスト** (マルチキー、タイムアウト、ペイン移動)
- [x] **カラースキームテスト** (ロール別、統一性、大文字小文字)
- [x] **プロセス管理テスト** (セッション管理、クリーンアップ)
- [x] **100%テストパス** (エラー0件)
- [x] **継続的品質保証** (dotnet test統合)

## 2. 🚨 緊急修正タスク (即座対応必要)

### 2.1 プロセス分離アーキテクチャ実装 (最優先・新規)
**tmuxライクな堅牢性確保のため、プロセス分離アーキテクチャを最優先で実装**
**参考設計**: [docs/process-architecture.md](docs/process-architecture.md)

#### 2.1.1 プロセススーパーバイザー基盤 (1週間以内)
- [ ] **ProcessSupervisor.fs 新規実装**
  - ワーカープロセス生存監視システム
  - 2秒間隔ハートビート確認機構
  - プロセス状態管理 (Starting/Running/Unhealthy/Crashed/Stopping)
  - 自動復旧制御 (3秒以内の再起動)
- [ ] **IPC通信機構実装**
  - Unix Domain Socket による高速通信
  - JSON-based protocol設計
  - 非同期メッセージキューイング
  - タイムアウト・エラーハンドリング
- [ ] **健全性監視システム**
  - メモリ使用量監視 (上限: 512MB/プロセス)
  - CPU使用率監視 (上限: 50%/プロセス)
  - 応答時間測定・しきい値管理
  - リソース枯渇時の自動介入

#### 2.1.2 Worker Process分離実装 (1週間以内)
- [ ] **各ペイン用独立プロセス起動**
  - Claude Code Worker プロセス分離実装
  - メインTUIプロセスとの完全独立性確保
  - クラッシュ分離機構の実装
- [ ] **プロセス間通信の安定化**
  - 標準入出力のIPC経由リダイレクト
  - UI更新の非同期ディスパッチ
  - メッセージロスト防止機構
- [ ] **異常終了時の影響分離**
  - 個別プロセスクラッシュのメインプロセス保護
  - 部分障害時の継続運用機能
  - ユーザー作業の中断最小化

### 2.2 予防的メンテナンス機能 (2週間以内)
**Claude Code (JSランタイム) 特性を考慮した安定性向上**

- [ ] **定期リブート機能**
  - 30-60分間隔での計画的再起動
  - Node.jsメモリリーク対策
  - アクティブ作業中の延期機能
- [ ] **セッション永続化**
  - tmuxライクなデタッチ/アタッチ機能
  - 異常終了時の作業状態復元
  - 会話履歴の自動保存・復元
- [ ] **リソース監視・制限**
  - プロセス毎のメモリ使用量制限
  - CPU使用率の継続監視
  - ガベージコレクション強制実行機能

### 2.3 Claude Code自動起動の修正 (堅牢性実装と併行)
- [x] **問題特定とログ強化** (TextViewアクセス失敗の詳細記録)
- [ ] **TextView初期化タイミング修正**
  - **症状**: "TextViewが見つかりません" エラー (100%発生)
  - **原因**: UI要素の初期化順序とTerminal.Guiレンダリングタイミング
  - **対策1**: Application.RunLoop後での遅延起動実装
  - **対策2**: UI構築完了イベント待機機構追加
  - **対策3**: TextView.IsInitialized チェック機能実装
- [ ] **フォールバック機能実装**
  - 自動起動失敗時の手動起動ガイダンス表示
  - Ctrl+X S での手動起動の安定化
  - エラー状態の視覚的フィードバック強化

## 3. 🔧 Claude Code統合 - 段階的実装 (高優先度)

### 3.1 Phase 1: 基本統合の完成 (30日以内)

#### 3.1.1 I/O統合実装 (最重要)
- [x] **プロセス起動基盤** (Process.Start実装済み)
- [ ] **標準出力キャプチャ**
  - Claude Code出力のリアルタイム取得
  - 非同期I/Oハンドリング実装
  - TextView.Textへの動的更新機構
- [ ] **標準入力送信**
  - ユーザー入力のClaude Codeプロセスへの転送
  - キーボード入力イベントの適切なルーティング
  - Enterキー、Escキー等の特殊キー処理
- [ ] **エラー出力処理**
  - StandardError の分離キャプチャ
  - エラーメッセージの色分け表示
  - 重要エラーの通知機構

#### 3.1.2 単一ペイン完全動作 (dev1から開始)
- [x] **dev1ペインの基盤準備** (TextView配置済み)
- [ ] **Claude Code認証連携**
  - 既存のClaude認証情報の継承
  - APIキー・セッション情報の適切な引き継ぎ
  - 認証エラー時の処理フロー
- [ ] **基本対話機能**
  - プロンプト入力 → Claude応答の完全なサイクル
  - 会話履歴の蓄積・表示
  - セッション状態の可視化
- [ ] **動作検証**
  - 10分間の連続対話テスト
  - ファイル操作コマンドの動作確認
  - メモリリーク・性能問題の検証

### 3.2 Phase 2: 複数ペイン展開 (60日以内)

#### 3.2.1 全ペイン対応
- [ ] **dev2/dev3ペイン対応** (dev1の実装パターン適用)
- [ ] **qa1/qa2ペイン対応** (QA専用プロンプト設定)
- [ ] **uxペイン対応** (UX観点のプロンプト設定)
- [ ] **pmペイン対応** (プロジェクト管理観点のプロンプト設定)

#### 3.2.2 同時セッション管理
- [x] **SessionManager実装** (複数セッション管理基盤)
- [ ] **リソース競合回避**
  - CPU使用率制限機構
  - 同時実行数制御 (最大4セッション等)
  - メモリ使用量監視
- [ ] **セッション間独立性**
  - 各ペインの作業ディレクトリ分離
  - プロセス間での環境変数独立化
  - ファイルロック競合の回避

### 3.3 Phase 3: 高度連携機能 (90日以内)

#### 3.3.1 ペイン間コンテキスト共有
- [ ] **会話ログ相互参照**
  - 他ペインの会話履歴の閲覧機能
  - キーワード検索・フィルタリング
  - 重要な発言のブックマーク機能
- [ ] **ファイル変更通知**
  - ファイルシステム監視機構
  - 変更内容の他ペインへの通知
  - 競合解決機構の実装
- [ ] **作業状況ブロードキャスト**
  - 各ペインの作業状況可視化
  - プロジェクト全体の進捗管理
  - タスク間の依存関係管理

#### 3.3.2 AI協調機能
- [ ] **マルチエージェント協調**
  - dev → qa → ux のワークフロー自動化
  - ペイン間でのタスク引き継ぎ機構
  - 品質チェックの自動実行
- [ ] **統合レポート生成**
  - 全ペインの活動サマリー
  - プロジェクト進捗の自動レポート
  - 品質指標の継続的監視

## 4. 🔧 基盤機能・品質向上

### 4.1 設定・構成管理
- [ ] **設定ファイル実装**
  - **場所**: `~/.config/claude-tui/config.toml`
  - **内容**: Claude CLI パス、ペイン設定、キーバインドカスタマイズ
  - **デフォルト設定**: 初回起動時の自動生成
  - **設定変更**: 実行時設定変更とファイル保存
- [ ] **環境変数統合**
  - CLAUDE_API_KEY等の自動検出
  - プロジェクト固有設定の優先制御
  - 設定階層の明確化

### 4.2 テスト・品質保証強化
- [x] **単体テスト基盤** (29テストケース、100%パス)
- [ ] **統合テストスイート**
  - Claude Code統合の自動テスト
  - UI操作の自動化テスト
  - 性能回帰テスト
- [ ] **継続的品質監視**
  - メモリリーク検出
  - CPU使用率監視
  - レスポンス時間測定

### 4.3 運用・保守性向上
- [x] **包括的ログシステム** (71行実装済み)
- [ ] **設定診断機能**
  - Claude CLI の動作確認
  - 権限・パス設定の検証
  - 問題箇所の自動特定
- [ ] **自動更新機構**
  - バージョン確認
  - 設定ファイルマイグレーション
  - 後方互換性保証

## 5. 🎯 技術実装詳細・アーキテクチャ設計

### 5.1 現在のアーキテクチャ状況
**実装済みモジュール構成**:
```
src/
├── Program.fs (224行) - メインUI・レイアウト・自動起動
├── KeyBindings.fs (246行) - Emacsキーバインド・アクション処理  
├── ClaudeCodeProcess.fs (190行) - プロセス管理・セッション制御
├── Logger.fs (71行) - ログシステム・デバッグ出力
└── ColorSchemes.fs (27行) - カラースキーム統一管理
```

### 5.2 技術課題と解決アプローチ

#### 5.2.1 🚨 緊急技術課題
- **TextView初期化競合**
  - **問題**: UI構築とSubview追加のタイミング齟齬
  - **解決案1**: Application.RunLoop開始後のコールバック実装
  - **解決案2**: View.LayoutCompleteイベント活用
  - **解決案3**: ポーリングベースのTextView検出

#### 5.2.2 I/O統合の技術的詳細
- **非同期プロセス管理**
  ```fsharp
  // 実装予定の非同期I/O処理
  type AsyncProcessManager() =
      member _.StartAsyncCapture(process: Process, textView: TextView) =
          // stdout/stderr の非同期読み取り
          // Terminal.GuiのUIスレッドへの安全なディスパッチ
  ```
- **UIスレッド安全性**
  - Terminal.GuiのメインスレッドでのUI更新保証
  - バックグラウンドプロセスからの安全な通知機構
  - デッドロック回避の排他制御

#### 5.2.3 パフォーマンス最適化
- **メモリ管理**
  - プロセス出力バッファの適切なサイズ制限
  - 長時間実行時のメモリリーク防止
  - GC圧迫の回避
- **CPU使用率制御**
  - 複数セッション時のCPU使用率監視
  - バックグラウンドプロセスの優先度制御
  - システムリソースの適切な配分

### 5.3 ペイン別特殊化設計

#### 5.3.1 役割別プロンプト設定
- **dev1-3ペイン**: 
  ```
  システムプロンプト: "あなたは熟練のソフトウェアエンジニアです。
  コード品質、パフォーマンス、保守性を重視してください。"
  ```
- **qa1-2ペイン**:
  ```
  システムプロンプト: "あなたは品質保証の専門家です。
  テスト戦略、バグ検出、品質向上に焦点を当ててください。"
  ```
- **uxペイン**:
  ```
  システムプロンプト: "あなたはUX/UIデザインの専門家です。
  ユーザビリティ、アクセシビリティ、使いやすさを重視してください。"
  ```
- **pmペイン**:
  ```
  システムプロンプト: "あなたはプロジェクトマネージャーです。
  進捗管理、リスク管理、品質管理の観点で支援してください。"
  ```

#### 5.3.2 ペイン間データフロー設計
```
会話ペイン ←→ [ログ集約] ←→ 各エージェントペイン
     ↓                           ↓
[ファイル監視システム] ←→ [作業状況共有DB]
```

## 6. 📋 開発マイルストーン・リリース計画

### 6.1 短期マイルストーン (30日以内)
**リリース v0.2.0 - "Claude統合基本版"**
- [ ] TextView初期化問題完全解決
- [ ] dev1ペインでの完全なClaude対話実現
- [ ] I/O統合の安定動作
- [ ] メモリリーク・パフォーマンス問題解決

### 6.2 中期マイルストーン (60日以内)
**リリース v0.3.0 - "マルチペイン版"**
- [ ] 全ペイン(dev1-3, qa1-2, ux, pm)での Claude対話
- [ ] ペイン別役割特殊化
- [ ] 同時セッション管理の安定化
- [ ] 設定ファイル機能

### 6.3 長期マイルストーン (90日以内)
**リリース v1.0.0 - "完全版"**
- [ ] ペイン間連携機能
- [ ] AI協調ワークフロー
- [ ] 統合レポート機能
- [ ] 運用監視・保守機能

---

## 📚 参照ドキュメント・技術情報

### 開発ドキュメント
| 資料 | 主な内容 | 実装関連度 |
|------|----------|----------|
| `CLAUDE.md` | プロジェクト技術仕様、アーキテクチャ設計 | ★★★ |
| `README.md` | ビルド・実行方法、ログシステム詳細 | ★★★ |
| `PRD.md` | プロダクト要件、チーム体制、技術選定 | ★★☆ |
| `docs/ui_layout.md` | UIレイアウト詳細、カラースキーム設計 | ★★☆ |

### 技術参考資料
| 技術 | 参照先 | 実装重要度 |
|------|--------|----------|
| Terminal.Gui API | [GitHub Wiki](https://github.com/gui-cs/Terminal.Gui) | ★★★ |
| F# 非同期処理 | [Microsoft Docs](https://docs.microsoft.com/en-us/dotnet/fsharp/tutorials/asynchronous-and-concurrent-programming/) | ★★★ |
| .NET Process管理 | [System.Diagnostics.Process](https://docs.microsoft.com/en-us/dotnet/api/system.diagnostics.process) | ★★★ |
| NUnit Testing | [NUnit Documentation](https://nunit.org/) | ★★☆ |

### コード品質・運用
- **ログファイル**: `/tmp/fcode-logs/fcode-{timestamp}.log`
- **テスト実行**: `dotnet test tests/fcode.Tests.fsproj`
- **カバレッジ**: `dotnet test --collect:"XPlat Code Coverage"`
- **パフォーマンス**: メモリ使用量・CPU使用率の継続監視

---

**最終更新**: 2025-06-25  
**次回レビュー予定**: TextView初期化問題解決後  
**課題管理**: このTODO.md + 必要に応じてGitHub Issues移行 
