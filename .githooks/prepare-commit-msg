#!/bin/bash

# prepare-commit-msg hook: --no-verify使用時の警告メッセージ

COMMIT_MSG_FILE=$1
COMMIT_SOURCE=$2

# カラー出力用の定数
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# --no-verify フラグが使用されたかを検出
# Git は --no-verify 使用時に prepare-commit-msg を呼び出すが、pre-commit をスキップする
if [ -z "$SKIP_VERIFY_CHECK" ]; then
    # pre-commit が実行されたかチェック（環境変数で判定）
    if [ -z "$PRE_COMMIT_EXECUTED" ]; then
        # pre-commit が実行されていない可能性 = --no-verify が使用された
        
        echo -e "${RED}⚠️  WARNING: --no-verify フラグが検出されました${NC}" >&2
        echo -e "${YELLOW}" >&2
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" >&2
        echo "🚨 コード品質チェックがスキップされました" >&2
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" >&2
        echo "" >&2
        echo "コミット前に以下のコマンドを実行して品質を確保してください：" >&2
        echo "" >&2
        echo -e "${BLUE}  make check${NC}     # 全品質チェック (推奨)" >&2
        echo "  または個別実行：" >&2
        echo -e "${BLUE}  make format${NC}   # F#コードフォーマット" >&2
        echo -e "${BLUE}  make lint${NC}     # リント実行" >&2
        echo -e "${BLUE}  make test${NC}     # テスト実行" >&2
        echo -e "${BLUE}  make build${NC}    # ビルド確認" >&2
        echo "" >&2
        echo -e "${YELLOW}問題が発見された場合は修正してから再コミットしてください。${NC}" >&2
        echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}" >&2
        echo "" >&2
        
        # コミットメッセージにも警告を追加
        echo "" >> "$COMMIT_MSG_FILE"
        echo "# ⚠️  WARNING: --no-verify でコミット品質チェックがスキップされました" >> "$COMMIT_MSG_FILE"
        echo "# 次のコマンドで品質チェックを実行してください:" >> "$COMMIT_MSG_FILE"
        echo "#   make check" >> "$COMMIT_MSG_FILE"
        echo "# 問題が発見されたら修正して git commit --amend してください" >> "$COMMIT_MSG_FILE"
    fi
fi