#!/bin/bash

# F# pre-commit hook: ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆãƒ»ãƒªãƒ³ãƒˆãƒ»ãƒ†ã‚¹ãƒˆãƒ»ãƒ“ãƒ«ãƒ‰ã®å®Ÿè¡Œ

set -e

# pre-commit ãŒå®Ÿè¡Œã•ã‚ŒãŸã“ã¨ã‚’ç¤ºã™ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
export PRE_COMMIT_EXECUTED=1

echo "ðŸ” Pre-commit checks starting..."

# ã‚«ãƒ©ãƒ¼å‡ºåŠ›ç”¨ã®å®šæ•°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†
handle_error() {
    echo -e "${RED}âŒ Pre-commit check failed: $1${NC}"
    exit 1
}

# æˆåŠŸæ™‚ã®å‡¦ç†
print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

# 1. ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆãƒã‚§ãƒƒã‚¯
print_info "Checking F# code formatting..."
if command -v fantomas &> /dev/null; then
    if fantomas --check src/ tests/ &> /dev/null; then
        print_success "Code formatting is correct"
    else
        print_warning "Code formatting issues detected. Auto-fixing..."
        fantomas src/ tests/
        if [ $? -eq 0 ]; then
            print_success "Code automatically formatted"
            echo -e "${YELLOW}ðŸ“ Files have been auto-formatted. Please review and re-commit.${NC}"
            exit 1
        else
            handle_error "Failed to format code"
        fi
    fi
else
    print_warning "Fantomas not found. Installing..."
    dotnet tool install -g fantomas
    if [ $? -ne 0 ]; then
        handle_error "Failed to install Fantomas"
    fi
    # Rerun formatting check
    if fantomas --check src/ tests/ &> /dev/null; then
        print_success "Code formatting is correct"
    else
        print_warning "Code formatting issues detected. Auto-fixing..."
        fantomas src/ tests/
        print_success "Code automatically formatted"
        echo -e "${YELLOW}ðŸ“ Files have been auto-formatted. Please review and re-commit.${NC}"
        exit 1
    fi
fi

# 2. ãƒªãƒ³ãƒˆ (è­¦å‘Šã‚’ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦æ‰±ã†)
print_info "Running F# linting..."
if dotnet build src/fcode.fsproj --configuration Debug --verbosity quiet --property TreatWarningsAsErrors=true > /dev/null 2>&1; then
    print_success "Main project linting passed"
else
    handle_error "Main project linting failed"
fi

if dotnet build tests/fcode.Tests.fsproj --configuration Debug --verbosity quiet --property TreatWarningsAsErrors=true > /dev/null 2>&1; then
    print_success "Test project linting passed"
else
    handle_error "Test project linting failed"
fi

# 3. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
print_info "Running tests..."
if dotnet test tests/fcode.Tests.fsproj --configuration Debug --verbosity quiet --nologo > /dev/null 2>&1; then
    print_success "All tests passed"
else
    handle_error "Tests failed"
fi

# 4. ãƒªãƒªãƒ¼ã‚¹ãƒ“ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯
print_info "Checking release build..."
if dotnet build src/fcode.fsproj --configuration Release --verbosity quiet > /dev/null 2>&1; then
    print_success "Release build successful"
else
    handle_error "Release build failed"
fi

echo -e "${GREEN}ðŸŽ‰ All pre-commit checks passed!${NC}"
echo ""