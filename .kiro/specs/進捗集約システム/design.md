# 設計書 - 進捗集約システム

## 概要

進捗集約システムは、fcodeのマルチエージェージェントの個別進捗を集約し、プロジェクト全体の進捗状況を統合管理するシステムです。リアルタイム集約、階層的進捗管理、予測分析、品質統合を提供し、効果的なプロジェクト管理を支援します。

## アーキテクチャ

### システムアーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                    進捗集約システム                          │
├─────────────────────────────────────────────────────────────┤
│ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ │
│ │ 進捗            │ │ 階層            │ │ 重み付け        │ │
│ │ 収集器          │ │ 管理器          │ │ 計算器          │ │
│ └─────────────────┘ └─────────────────┘ └─────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ │
│ │ トレンド        │ │ 予測            │ │ 遅延            │ │
│ │ 分析器          │ │ エンジン        │ │ 検出器          │ │
│ └─────────────────┘ └─────────────────┘ └─────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ │
│ │ 品質            │ │ ルール          │ │ アラート        │ │
│ │ 統合器          │ │ エンジン        │ │ 管理器          │ │
│ └─────────────────┘ └─────────────────┘ └─────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### データフローアーキテクチャ

```
[個別進捗] → [進捗収集器] → [検証]
     ↓            ↓           ↓
[階層集約] → [重み付け計算] → [品質統合]
     ↓            ↓           ↓
[トレンド分析] → [予測エンジン] → [遅延検出]
     ↓            ↓           ↓
[アラート生成] → [通知] → [ダッシュボード更新]
```

## コンポーネントとインターフェース

### 進捗集約器

メインの進捗集約コンポーネント

```fsharp
type 進捗集約器() =
    
    // 個別進捗の更新
    member _.進捗更新(タスクID: string, 進捗: float, エージェントID: string) : Result<unit, 進捗エラー>
    
    // 全体進捗の取得
    member _.全体進捗取得() : Result<全体進捗, 進捗エラー>
    
    // プロジェクト進捗の取得
    member _.プロジェクト進捗取得(プロジェクトID: string) : Result<プロジェクト進捗, 進捗エラー>
    
    // 階層的進捗の取得
    member _.階層進捗取得(ルートタスクID: string) : Result<階層進捗, 進捗エラー>
    
    // 進捗変更イベントの購読
    member _.進捗変更イベント購読(ハンドラー: 進捗変更 -> unit) : IDisposable
```

### 進捗収集器

進捗収集コンポーネント

```fsharp
type 進捗収集器() =
    
    // 進捗データの収集
    member _.進捗収集(ソース群: 進捗ソース list) : Result<進捗データ list, 収集エラー>
    
    // リアルタイム進捗監視
    member _.リアルタイム収集開始(間隔: TimeSpan) : IDisposable
    
    // 進捗データの検証
    member _.進捗データ検証(データ: 進捗データ) : 検証結果
    
    // 異常値の検出・修正
    member _.異常検出修正(データ群: 進捗データ list) : 修正済み進捗データ list
```

### 階層管理器

階層的進捗管理コンポーネント

```fsharp
type 階層管理器() =
    
    // 階層構造の管理
    member _.階層構築(タスク群: タスク情報 list) : タスク階層
    
    // 階層的進捗の計算
    member _.階層進捗計算(階層: タスク階層, 進捗データ: Map<string, float>) : 階層進捗
    
    // 親子関係の更新
    member _.階層更新(タスクID: string, 親ID: string option) : Result<unit, 階層エラー>
    
    // 階層整合性の検証
    member _.階層検証(階層: タスク階層) : 階層検証結果
```

### 重み付け計算器

重み付け計算コンポーネント

```fsharp
type 重み付け計算器() =
    
    // 重み付き進捗の計算
    member _.重み付き進捗計算(進捗データ群: 重み付き進捗データ list) : float
    
    // 重み設定の管理
    member _.重み設定(タスク重み: Map<string, float>) : Result<unit, 重みエラー>
    
    // 動的重み調整
    member _.重み調整(調整ルール群: 重み調整ルール list) : Result<Map<string, float>, 重みエラー>
    
    // 重み最適化
    member _.重み最適化(ビジネス価値: Map<string, float>, 制約群: 重み制約 list) : 重み最適化結果
```

## データモデル

### 全体進捗

```fsharp
type 全体進捗 = {
    総タスク数: int
    完了タスク数: int
    進行中タスク数: int
    待機タスク数: int
    全体完了率: float
    重み付き完了率: float
    完了予定日: DateTime option
    ベロシティ: ベロシティ指標
    トレンド: 進捗トレンド
    品質指標: 品質進捗指標
    リスク群: 進捗リスク list
}

and ベロシティ指標 = {
    現在ベロシティ: float
    平均ベロシティ: float
    ベロシティトレンド: トレンド方向
    予測ベロシティ: float
    ベロシティ要因群: ベロシティ要因 list
}

and 進捗トレンド = {
    完了トレンド: トレンド分析
    ベロシティトレンド: トレンド分析
    品質トレンド: トレンド分析
    効率トレンド: トレンド分析
}

and 進捗リスク = {
    リスクID: string
    リスク種別: 進捗リスク種別
    深刻度: リスク深刻度
    確率: float
    影響: リスク影響
    軽減戦略群: 軽減戦略 list
}
```

### プロジェクト進捗

```fsharp
type プロジェクト進捗 = {
    プロジェクトID: string
    プロジェクト名: string
    開始日: DateTime
    予定終了日: DateTime
    予測終了日: DateTime option
    完了率: float
    重み付き完了率: float
    マイルストーン群: マイルストーン進捗 list
    フェーズ群: フェーズ進捗 list
    エージェント貢献群: エージェント貢献 list
    ボトルネック分析群: ボトルネック情報 list
}

and マイルストーン進捗 = {
    マイルストーンID: string
    名前: string
    予定日: DateTime
    予測日: DateTime option
    完了率: float
    状況: マイルストーン状況
    依存関係群: string list
    クリティカルパス: bool
}

and フェーズ進捗 = {
    フェーズID: string
    名前: string
    完了率: float
    タスク数: int
    完了タスク数: int
    予定期間: TimeSpan
    実際期間: TimeSpan option
    効率スコア: float
}

and エージェント貢献 = {
    エージェントID: string
    割り当てタスク数: int
    完了タスク数: int
    貢献率: float
    効率スコア: float
    品質スコア: float
}
```

### 階層進捗

```fsharp
type 階層進捗 = {
    ルートタスク: タスク進捗ノード
    総深度: int
    完了サマリー: 完了サマリー
    クリティカルパス: タスク進捗ノード list
    ボトルネックノード群: タスク進捗ノード list
}

and タスク進捗ノード = {
    タスクID: string
    タスク名: string
    進捗: float
    重み: float
    重み付き進捗: float
    子ノード群: タスク進捗ノード list
    依存関係群: string list
    状況: タスク状況
    完了予定: DateTime option
    実際完了: DateTime option
    品質スコア: float option
}

and 完了サマリー = {
    総ノード数: int
    完了ノード数: int
    進行中ノード数: int
    待機ノード数: int
    ブロックノード数: int
    完了率: float
    重み付き完了率: float
}
```

### 進捗予測

```fsharp
type 進捗予測 = {
    予測ID: string
    生成日時: DateTime
    予測期間: TimeSpan
    シナリオ群: 予測シナリオ list
    推奨シナリオ: 予測シナリオ
    信頼度: float
    前提条件群: 予測前提条件 list
}

and 予測シナリオ = {
    シナリオ名: string
    シナリオ種別: シナリオ種別
    完了予測日: DateTime
    完了確率: float
    必要リソース群: リソース要件 list
    リスク要因群: 予測リスク list
    推奨事項群: 予測推奨事項 list
}

and シナリオ種別 =
    | 楽観的
    | 現実的
    | 悲観的
    | カスタム of パラメータ群: Map<string, obj>

and 予測前提条件 = {
    前提条件ID: string
    説明: string
    信頼度: float
    影響: 前提条件影響
    検証: 前提条件検証 option
}
```

## コアアルゴリズム

### 進捗集約アルゴリズム

```fsharp
let 進捗集約 (進捗データ群: 進捗データ list) (階層: タスク階層) (重み群: Map<string, float>) : 全体進捗 =
    // 1. データ検証と前処理
    let 検証済みデータ = 進捗データ群 |> List.map 進捗データ検証 |> List.choose id
    
    // 2. 階層的集約
    let 階層進捗 = 階層進捗計算 階層 検証済みデータ
    
    // 3. 重み付き計算
    let 重み付き進捗 = 重み付き進捗計算 検証済みデータ 重み群
    
    // 4. 統計計算
    let 総タスク数 = 検証済みデータ.Length
    let 完了タスク数 = 検証済みデータ |> List.filter (fun p -> p.進捗 >= 1.0) |> List.length
    let 進行中タスク数 = 検証済みデータ |> List.filter (fun p -> p.進捗 > 0.0 && p.進捗 < 1.0) |> List.length
    let 待機タスク数 = 総タスク数 - 完了タスク数 - 進行中タスク数
    
    // 5. ベロシティ計算
    let ベロシティ = ベロシティ指標計算 検証済みデータ
    
    // 6. トレンド分析
    let トレンド = 進捗トレンド分析 検証済みデータ
    
    // 7. 品質統合
    let 品質指標 = 品質指標統合 検証済みデータ
    
    // 8. リスク分析
    let リスク群 = 進捗リスク分析 検証済みデータ トレンド
    
    {
        総タスク数 = 総タスク数
        完了タスク数 = 完了タスク数
        進行中タスク数 = 進行中タスク数
        待機タスク数 = 待機タスク数
        全体完了率 = float 完了タスク数 / float 総タスク数
        重み付き完了率 = 重み付き進捗
        完了予定日 = 完了日予測 ベロシティ トレンド
        ベロシティ = ベロシティ
        トレンド = トレンド
        品質指標 = 品質指標
        リスク群 = リスク群
    }
```

### 予測アルゴリズム

```fsharp
let 進捗予測 (現在進捗: 全体進捗) (履歴データ: 進捗データ list) (制約群: 予測制約 list) : 進捗予測 =
    // 1. 履歴データ分析
    let 履歴トレンド = 履歴トレンド分析 履歴データ
    let 季節パターン = 季節パターン検出 履歴データ
    
    // 2. 現在状況分析
    let 現在ベロシティ = 現在進捗.ベロシティ.現在ベロシティ
    let 現在トレンド = 現在進捗.トレンド.完了トレンド
    
    // 3. 予測モデル適用
    let 線形予測 = 線形予測適用 現在ベロシティ 現在トレンド
    let 指数予測 = 指数平滑適用 履歴トレンド
    let 季節予測 = 季節調整適用 線形予測 季節パターン
    
    // 4. シナリオ生成
    let 楽観シナリオ = 楽観シナリオ生成 線形予測 制約群
    let 現実シナリオ = 現実シナリオ生成 指数予測 制約群
    let 悲観シナリオ = 悲観シナリオ生成 季節予測 制約群
    
    // 5. 信頼度計算
    let 信頼度 = 予測信頼度計算 履歴トレンド 現在トレンド
    
    // 6. 推奨シナリオ選択
    let 推奨シナリオ = 推奨シナリオ選択 [楽観シナリオ; 現実シナリオ; 悲観シナリオ] 信頼度
    
    // 7. 前提条件抽出
    let 前提条件群 = 予測前提条件抽出 制約群 履歴トレンド
    
    {
        予測ID = Guid.NewGuid().ToString()
        生成日時 = DateTime.UtcNow
        予測期間 = 予測期間計算 現在進捗
        シナリオ群 = [楽観シナリオ; 現実シナリオ; 悲観シナリオ]
        推奨シナリオ = 推奨シナリオ
        信頼度 = 信頼度
        前提条件群 = 前提条件群
    }
```

### 遅延検出アルゴリズム

```fsharp
let 遅延検出 (現在進捗: 全体進捗) (計画進捗: 計画進捗) (閾値群: 遅延閾値 list) : 遅延情報 list =
    let 遅延群 = ResizeArray<遅延情報>()
    
    // 1. 全体進捗遅延検出
    let 全体遅延 = 全体遅延検出 現在進捗 計画進捗
    if 全体遅延.IsSome then 遅延群.Add(全体遅延.Value)
    
    // 2. マイルストーン遅延検出
    let マイルストーン遅延群 = マイルストーン遅延検出 現在進捗.マイルストーン群 計画進捗.マイルストーン群
    遅延群.AddRange(マイルストーン遅延群)
    
    // 3. ベロシティ遅延検出
    let ベロシティ遅延群 = ベロシティ遅延検出 現在進捗.ベロシティ 計画進捗.期待ベロシティ
    遅延群.AddRange(ベロシティ遅延群)
    
    // 4. 品質遅延検出
    let 品質遅延群 = 品質遅延検出 現在進捗.品質指標 計画進捗.品質目標
    遅延群.AddRange(品質遅延群)
    
    // 5. 遅延重要度評価
    遅延群
    |> Seq.map (fun 遅延 -> 遅延深刻度評価 遅延 閾値群)
    |> Seq.filter (fun 遅延 -> 遅延.深刻度 >= 遅延閾値.最小深刻度)
    |> Seq.sortByDescending (fun 遅延 -> 遅延.深刻度)
    |> Seq.toList
```

## エラーハンドリング

### 進捗集約エラー種別

```fsharp
type 進捗エラー =
    | データ検証エラー of 検証: 検証エラー list
    | 集約エラー of 理由: string
    | 階層エラー of 階層: 階層エラー
    | 重み計算エラー of 重み: 重みエラー
    | 予測エラー of 予測: 予測エラー
    | 統合エラー of システム: string * エラー: string

let 進捗エラー処理 エラー =
    match エラー with
    | データ検証エラー 検証エラー群 ->
        // データ検証エラーの処理
        検証エラーログ 検証エラー群
        データ修正試行 検証エラー群
    | 集約エラー 理由 ->
        // 集約エラーの処理
        集約エラーログ 理由
        最終既知良好進捗使用 理由
    | 階層エラー 階層エラー ->
        // 階層エラーの処理
        階層エラーログ 階層エラー
        階層再構築 階層エラー
    | 重み計算エラー 重みエラー ->
        // 重み計算エラーの処理
        重みエラーログ 重みエラー
        デフォルト重み使用 重みエラー
    | 予測エラー 予測エラー ->
        // 予測エラーの処理
        予測エラーログ 予測エラー
        簡単予測使用 予測エラー
    | 統合エラー (システム, エラー) ->
        // 統合エラーの処理
        統合エラーログ システム エラー
        スタンドアロンモード使用 システム
```

## パフォーマンス最適化

### キャッシュ戦略

```fsharp
type 進捗キャッシュ = {
    全体進捗キャッシュ: LRUCache<string, 全体進捗>
    プロジェクト進捗キャッシュ: LRUCache<string, プロジェクト進捗>
    階層進捗キャッシュ: LRUCache<string, 階層進捗>
    予測キャッシュ: LRUCache<string, 進捗予測>
}

let キャッシュ戦略 = {
    全体進捗キャッシュ = LRUCache.create 50 (TimeSpan.FromMinutes 2.0)
    プロジェクト進捗キャッシュ = LRUCache.create 200 (TimeSpan.FromMinutes 5.0)
    階層進捗キャッシュ = LRUCache.create 100 (TimeSpan.FromMinutes 10.0)
    予測キャッシュ = LRUCache.create 30 (TimeSpan.FromMinutes 30.0)
}
```

### 増分集約

```fsharp
let 増分集約 (前回進捗: 全体進捗) (進捗更新群: 進捗更新 list) : 全体進捗 =
    // 差分更新による効率的な集約
    let 影響タスク群 = 進捗更新群 |> List.map (fun 更新 -> 更新.タスクID) |> Set.ofList
    let 未変更進捗 = 未変更進捗フィルタ 前回進捗 影響タスク群
    let 更新進捗 = 更新進捗計算 進捗更新群
    
    進捗データマージ 未変更進捗 更新進捗
```

## 統合ポイント

### 既存システム統合

- **エージェント状態管理器**: エージェント状態との進捗同期
- **タスク依存関係グラフ**: 依存関係を考慮した進捗計算
- **品質ゲート管理器**: 品質評価との統合
- **リアルタイム協調ファサード**: 協調進捗の統合

## セキュリティ考慮事項

- **進捗データ保護**: 進捗情報の機密性保護
- **アクセス制御**: 進捗情報への適切なアクセス制御
- **データ整合性**: 進捗データの改ざん防止
- **監査ログ**: 進捗変更の追跡可能性

## テスト戦略

### 単体テスト

```fsharp
[<Fact>]
let ``進捗集約 - 基本集約`` () =
    // Given
    let 集約器 = 進捗集約器()
    let 進捗データ = テスト進捗データ作成()
    
    // When
    let 結果 = 集約器.進捗集約(進捗データ)
    
    // Then
    match 結果 with
    | Ok 全体進捗 -> 
        Assert.True(全体進捗.全体完了率 >= 0.0 && 全体進捗.全体完了率 <= 1.0)
    | Error エラー -> Assert.True(false, $"集約失敗: {エラー}")

[<Fact>]
let ``進捗予測 - 完了日予測`` () =
    // Given
    let 予測器 = 予測エンジン()
    let 現在進捗 = テスト全体進捗作成()
    let 履歴データ = テスト履歴データ作成()
    
    // When
    let 予測 = 予測器.進捗予測(現在進捗, 履歴データ)
    
    // Then
    Assert.NotNull(予測.完了予定日)
    Assert.True(予測.信頼度 > 0.0)
```

## 監視とメトリクス

### 主要パフォーマンス指標

```fsharp
type 進捗集約器メトリクス = {
    集約レイテンシ: TimeSpan
    予測精度: float
    キャッシュヒット率: float
    エラー率: float
    秒間スループット: float
    データ鮮度: TimeSpan
}
```

### リアルタイム監視

- 進捗集約のレイテンシ監視
- 予測精度の追跡
- キャッシュ効率の監視
- データ鮮度の監視
- システムスループットの測定
